<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Trading HUD - TradingView Charts</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://s3.tradingview.com/tv.js"></script> 
    <script src="ai-engine.js" defer></script>
    
    <style>
        /* ========== THEME VARIABLES (Dark Mode by default) ========== */
        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #131722;
            --bg-card: rgba(19, 23, 34, 0.9);
            --bg-panel: rgba(28, 33, 48, 0.98);
            --border-color: #1c2130;
            --text-color: #ffffff;
            --chart-bg: #000000;
        }

        /* ========== LIGHT MODE OVERRIDES ========== */
        body.light-mode {
            --bg-primary: #f0f2f5;
            --bg-secondary: #ffffff;
            --bg-card: #e8e8e8;
            --bg-panel: #ffffff;
            --border-color: #d1d9e6;
            --text-color: #333333;
            --chart-bg: #ffffff;
        }

        /* ========== RESET & BASE (Uses variables) ========== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: var(--bg-primary);
            color: var(--text-color);
            font-family: 'Nunito', sans-serif;
            /* Removed padding-bottom as footer is no longer fixed */
            padding-bottom: 20px; 
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            transition: background-color 0.5s, color 0.5s; 
        }
        
        /* ========== HEADER ========== */
        .trading-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            background: var(--bg-secondary);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0, 184, 148, 0.2);
            position: sticky;
            top: 0;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .header-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: var(--border-color);
            color: var(--text-color);
            border: none;
            padding: 10px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .theme-toggle:hover {
            transform: scale(1.1);
        }
        
        .coin-selector {
            background: linear-gradient(135deg, #00b894 0%, #0984e3 100%);
            padding: 10px 20px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 800;
            font-size: 16px;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
            transition: all 0.3s ease;
            border: none;
            display: flex;
            align-items: center;
            gap: 8px;
            min-width: 100px;
            justify-content: center;
        }
        
        .coin-selector:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 184, 148, 0.5);
        }
        
        .live-indicator {
            background: linear-gradient(135deg, #d63031 0%, #e17055 100%);
            color: white;
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 13px;
            font-weight: 800;
            display: flex;
            align-items: center;
            gap: 6px;
            animation: pulse 2s infinite;
            box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.9; }
            100% { transform: scale(1); opacity: 1; }
        }
        
        /* ========== AI FOOTER PANEL (NOW INLINE CONTENT) ========== */
        .ai-footer-panel {
            /* Removed fixed positioning */
            position: relative; /* Changed from fixed */
            width: 100%;
            margin: 0;
            padding: 15px;
            /* Using standard background for inline appearance */
            background: var(--bg-secondary);
            border-bottom: 2px solid rgba(0, 184, 148, 0.3);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            z-index: 500; /* Ensure it is above charts but below header */
            height: auto; /* Allow content to dictate height */
        }
        
        .ai-stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 12px;
            flex: 1;
        }
        
        .stat-card {
            background: var(--bg-card);
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 70px;
        }
        
        .stat-title {
            font-size: 12px;
            opacity: 0.8;
            margin-bottom: 6px;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            white-space: nowrap;
        }
        
        .stat-value {
            font-size: 22px;
            font-weight: 900;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            height: 30px;
        }
        
        .power-indicator-container {
            width: 100%;
            height: 10px;
            background: var(--bg-card);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin: 8px 0;
            border: 1px solid var(--border-color);
        }
        
        .power-indicator {
            height: 100%;
            display: flex;
            width: 100%;
        }
        
        .buy-indicator {
            background: linear-gradient(90deg, #00b894, #00cec9);
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .sell-indicator {
            background: linear-gradient(90deg, #d63031, #e17055);
            height: 100%;
            transition: width 0.5s ease;
        }
        
        .confidence-bars {
            display: flex;
            gap: 2px;
            height: 20px;
            align-items: flex-end;
            justify-content: center;
        }
        
        .confidence-bar {
            width: 4px;
            background: #444;
            border-radius: 2px 2px 0 0;
            transition: all 0.3s ease;
        }
        
        .live-status-bar {
            display: grid;
            grid-template-columns: 2fr 1fr 1fr 1fr;
            gap: 10px;
            align-items: center;
            padding: 8px 10px;
            background: var(--border-color);
            border-radius: 8px;
            font-size: 11px;
            border: 1px solid rgba(42, 48, 66, 0.5);
            margin-bottom: 5px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-item.time {
            justify-content: flex-end;
            grid-column: 4 / 5;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .status-dot.live {
            background: #00b894;
            animation: blink 1.5s infinite;
        }
        
        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* ========== CHARTS SECTION ========== */
        .charts-section {
            padding: 15px;
            margin-bottom: 0;
        }
        
        .chart-label-wrapper {
            margin-bottom: 15px;
        }
        
        .chart-label {
            margin-bottom: 5px;
            padding: 8px 15px;
            background: var(--border-color);
            border-radius: 12px 12px 0 0;
            font-size: 16px;
            font-weight: 700;
            color: var(--text-color);
            border-bottom: 1px solid rgba(0, 184, 148, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chart-label .timeframe {
            color: #00b894;
            font-size: 18px;
            margin-left: 5px;
        }
        
        .chart-label i {
            color: #0984e3;
            font-size: 14px;
        }
        
        .chart-container {
            height: 450px;
            width: 100%;
            background: var(--chart-bg);
            border-radius: 0 0 16px 16px;
            overflow: hidden;
            margin-top: -15px;
            border: 2px solid var(--border-color);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
            position: relative;
            padding: 4px;
            transition: border-color 0.3s ease;
        }
        
        .chart-container:hover {
            border-color: #00b894;
        }
        
        .chart-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 10px;
        }
        
        /* ========== COIN MODAL ========== */
        .coin-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            backdrop-filter: blur(5px);
        }

        .light-mode .coin-modal {
             background: rgba(255, 255, 255, 0.95);
        }
        
        .modal-content {
            background: linear-gradient(135deg, var(--border-color) 0%, var(--bg-secondary) 100%);
            width: 90%;
            max-width: 500px;
            border-radius: 16px;
            padding: 25px;
            border: 2px solid #00b894;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
        }
        
        .coin-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }
        
        .coin-option {
            padding: 15px 10px;
            background: rgba(255, 255, 255, 0.08); 
            border-radius: 12px;
            cursor: pointer;
            font-weight: 700;
            font-size: 14px;
            transition: all 0.3s ease;
            text-align: center;
            border: 2px solid transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: var(--text-color);
        }

        .light-mode .coin-option {
            background: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }
        
        .coin-option i {
            font-size: 24px;
            color: #0984e3;
            transition: color 0.3s ease;
        }

        .light-mode .coin-option i {
            color: #0984e3;
        }
        
        .coin-option:hover {
            background: rgba(0, 184, 148, 0.25);
            border-color: #00b894;
            color: var(--text-color);
        }
        
        .coin-option.active {
            background: linear-gradient(135deg, #00b894 0%, #0984e3 100%);
            border-color: white;
            color: white;
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.5);
            transform: scale(1.03);
        }
        
        .coin-option.active i {
            color: white;
        }

        .modal-header {
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 15px;
        }

        .light-mode .modal-header {
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* ========== COLOR CLASSES ========== */
        .color-green { color: #00b894 !important; }
        .color-red { color: #d63031 !important; }
        .color-yellow { color: #f1c40f !important; }
        .color-blue { color: #0984e3 !important; }
        
        /* ========== RESPONSIVE DESIGN ========== */
        @media (max-width: 768px) {
            body { padding-bottom: 10px; }
            .charts-section { margin-bottom: 0; }
            .chart-container { height: 300px; }
            .chart-grid { grid-template-columns: 1fr; }
            .chart-label {
                font-size: 14px;
                padding: 6px 12px;
            }
            .chart-label .timeframe {
                font-size: 16px;
            }
            .chart-label-wrapper {
                margin-bottom: 10px;
            }
            .coin-grid { grid-template-columns: repeat(2, 1fr); }
            .modal-content { max-width: 350px; }
            
            /* Revised mobile status bar */
            .live-status-bar {
                 grid-template-columns: 1fr 1fr;
                 gap: 8px;
                 font-size: 10px;
                 padding: 6px 8px;
            }
            .status-item.time {
                grid-column: span 1;
                justify-content: flex-start;
            }
            .status-item:nth-child(4) { /* R:R moved to the right side of the second row */
                grid-column: 2 / 3;
                justify-content: flex-end;
            }
        }
        
        @media (max-width: 480px) {
            body { padding-bottom: 10px; }
            .charts-section { margin-bottom: 0; }
            .chart-grid { grid-template-columns: 1fr; }
            .chart-container { height: 250px; }
            .chart-label {
                font-size: 12px;
                padding: 4px 10px;
            }
            .coin-grid { grid-template-columns: 1fr; }
            .modal-content { padding: 15px; }
        }
    </style>
</head>

<body>
    <header class="trading-header">
        <button class="coin-selector" id="coinSelector">
            <i class="fas fa-chart-line"></i>
            <span id="currentCoin">BTC</span>
            <i class="fas fa-chevron-down"></i>
        </button>
        
        <div class="header-controls">
             <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>

            <div class="live-indicator">
                <i class="fas fa-circle"></i>
                AI LIVE
                <span class="status-dot live"></span>
            </div>
        </div>
    </header>

    <div class="ai-footer-panel" id="aiFooter">
        <div class="live-status-bar">
            <div class="status-item" style="grid-column: 1 / 3;"> 
                <div class="status-dot live"></div>
                <span>AI: <strong id="aiStatus" class="color-yellow">NEUTRAL</strong></span>
            </div>
             <div class="status-item">
                <i class="fas fa-exclamation-triangle"></i>
                <span>RISK: <strong id="riskStatus" class="color-green">LOW</strong></span>
            </div>
             <div class="status-item">
                <i class="fas fa-chart-line"></i>
                <span>VOLUME: <strong id="volumeStatus" class="color-yellow">MODERATE</strong></span>
            </div>
            <div class="status-item">
                <i class="fas fa-sync-alt"></i>
                <span>R:R: <strong id="rrStatus" class="color-yellow">1:1.5</strong></span>
            </div>
            <div class="status-item time" style="grid-column: 4 / 5;">
                <i class="fas fa-clock"></i>
                <span><strong id="lastUpdate">--:--:--</strong></span> 
            </div>
        </div>

        <div class="power-indicator-container">
            <div class="power-indicator">
                <div class="buy-indicator" id="buyIndicator" style="width: 50%"></div>
                <div class="sell-indicator" id="sellIndicator" style="width: 50%"></div>
            </div>
        </div>
        
        <div class="ai-stats-grid">
            <div class="stat-card" id="buyCard">
                <div class="stat-title">
                    <i class="fas fa-arrow-up"></i>
                    BUY POWER
                </div>
                <div class="stat-value" id="buyValue">
                    <span class="value" id="buyPowerValue">50%</span>
                </div>
            </div>
            
            <div class="stat-card" id="confidenceCard">
                <div class="stat-title">
                    <i class="fas fa-brain"></i>
                    AI CONFIDENCE
                </div>
                <div class="stat-value">
                    <span class="value" id="confidenceValue">5</span>
                    <div class="confidence-bars" id="confidenceBars"></div>
                </div>
            </div>
            
            <div class="stat-card" id="sellCard">
                <div class="stat-title">
                    <i class="fas fa-arrow-down"></i>
                    SELL POWER
                </div>
                <div class="stat-value" id="sellValue">
                    <span class="value" id="sellPowerValue">50%</span>
                </div>
            </div>
        </div>
    </div>

    <main class="charts-section">
        <div class="chart-label-wrapper">
            <div class="chart-label">
                <i class="fas fa-bolt"></i>
                <span class="coin-name" id="label-coin-1m">BTC</span>
                <span class="timeframe">1m</span>
            </div>
            <div class="chart-container">
                <div id="tv-1m" style="width: 100%; height: 100%;"></div>
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-label-wrapper">
                <div class="chart-label">
                    <i class="fas fa-chart-area"></i>
                    <span class="coin-name" id="label-coin-5m">BTC</span>
                    <span class="timeframe">5m</span>
                </div>
                <div class="chart-container">
                    <div id="tv-5m" style="width: 100%; height: 100%;"></div>
                </div>
            </div>

            <div class="chart-label-wrapper">
                <div class="chart-label">
                    <i class="fas fa-chart-area"></i>
                    <span class="coin-name" id="label-coin-15m">BTC</span>
                    <span class="timeframe">15m</span>
                </div>
                <div class="chart-container">
                    <div id="tv-15m" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="chart-grid">
            <div class="chart-label-wrapper">
                <div class="chart-label">
                    <i class="fas fa-chart-bar"></i>
                    <span class="coin-name" id="label-coin-30m">BTC</span>
                    <span class="timeframe">30m</span>
                </div>
                <div class="chart-container">
                    <div id="tv-30m" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
            <div class="chart-label-wrapper">
                <div class="chart-label">
                    <i class="fas fa-chart-bar"></i>
                    <span class="coin-name" id="label-coin-1h">BTC</span>
                    <span class="timeframe">1h</span>
                </div>
                <div class="chart-container">
                    <div id="tv-1h" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-label-wrapper">
                <div class="chart-label">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="coin-name" id="label-coin-4h">BTC</span>
                    <span class="timeframe">4h</span>
                </div>
                <div class="chart-container">
                    <div id="tv-4h" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
            <div class="chart-label-wrapper">
                <div class="chart-label">
                    <i class="fas fa-calendar-alt"></i>
                    <span class="coin-name" id="label-coin-1d">BTC</span>
                    <span class="timeframe">1D</span>
                </div>
                <div class="chart-container">
                    <div id="tv-1d" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="chart-grid" style="grid-template-columns: 1fr;">
            <div class="chart-label-wrapper">
                <div class="chart-label">
                    <i class="fas fa-history"></i>
                    <span class="coin-name" id="label-coin-1w">BTC</span>
                    <span class="timeframe">1W</span>
                </div>
                <div class="chart-container">
                    <div id="tv-1w" style="width: 100%; height: 100%;"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="coin-modal" id="coinModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: #00b894; text-align: center; margin-bottom: 10px;">
                    <i class="fas fa-coins"></i>
                    Select Trading Pair
                </h3>
            </div>
            <div class="coin-grid" id="coinGrid">
                </div>
        </div>
    </div>

    <script>
        // ===============================================
        // TRADINGVIEW CHARTS MANAGER
        // ===============================================

        const COIN_ICONS = {
            "BTC": "fab fa-btc", 
            "ETH": "fab fa-ethereum",
            "BNB": "fas fa-money-bill-wave",
            "SOL": "fas fa-sun",
            "XRP": "fas fa-hand-holding-usd",
            "ADA": "fas fa-leaf",
            "DOGE": "fas fa-dog",
            "MATIC": "fas fa-cube",
            "DOT": "fas fa-dot-circle",
            "LTC": "fas fa-shekel-sign",
            "TRX": "fas fa-code",
            "AVAX": "fas fa-mountain",
            "LINK": "fas fa-link",
            "ATOM": "fas fa-atom",
            "ETC": "fas fa-ethernet",
        };
        
        window.ACTIVE_SYMBOL = localStorage.getItem('activeSymbol') || "BTCUSDT"; 
        window.TRADING_COINS = [
            "BTCUSDT", "ETHUSDT", "BNBUSDT", "SOLUSDT", "XRPUSDT",
            "ADAUSDT", "DOGEUSDT", "MATICUSDT", "DOTUSDT", "LTCUSDT",
            "TRXUSDT", "AVAXUSDT", "LINKUSDT", "ATOMUSDT", "ETCUSDT"
        ];
        
        window.tvWidgets = {}; 

        window.getCoinIcon = function(coinName) {
            return COIN_ICONS[coinName] || "fas fa-globe";
        }

        window.destroyCharts = function() {
            for (const id in window.tvWidgets) {
                const el = document.getElementById(id);
                if (el) el.innerHTML = '';
            }
            window.tvWidgets = {};
        };

        window.initCharts = function(symbol = window.ACTIVE_SYMBOL) {
            console.log(`ðŸ“ˆ Initializing charts for: ${symbol}`);
            
            window.destroyCharts();
            
            const isLightMode = document.body.classList.contains('light-mode');
            const theme = isLightMode ? "light" : "dark";
            
            const configs = [
                { id: 'tv-1m', interval: '1' },
                { id: 'tv-5m', interval: '5' },
                { id: 'tv-15m', interval: '15' },
                { id: 'tv-30m', interval: '30' },
                { id: 'tv-1h', interval: '60' },
                { id: 'tv-4h', interval: '240' },
                { id: 'tv-1d', interval: '1D' },
                { id: 'tv-1w', interval: '1W' }
            ];
            
            const disabledFeatures = [
                "header_symbol_search", "header_settings", "header_compare",
                "header_undo_redo", "header_screenshot", "timeframes_toolbar",
                "header_indicators", "legend_context_menu", "pane_context_menu",
                "main_series_context_menu", "property_pages", "context_menus",
                "border_around_the_chart", "volume_force_overlay", "widget_logo",
                "header_widget_dom_node", "left_toolbar", "control_points",
                "scales_context_menu", "source_select_menu", "time_left_indicator",
                "show_symbol_logos", "symbol_info", "header_chart_type", "header_interval"
            ];
            
            configs.forEach(config => {
                const intervalName = config.interval.toLowerCase()
                    .replace('60', '1h').replace('240', '4h');
                const labelId = `label-coin-${intervalName}`;
                const labelElement = document.getElementById(labelId);
                
                if (labelElement) {
                    labelElement.textContent = symbol.replace("USDT", "").replace("USD", "");
                }
                
                requestAnimationFrame(() => {
                    const container = document.getElementById(config.id);
                    if (container && typeof TradingView.widget === 'function') {
                        window.tvWidgets[config.id] = new TradingView.widget({
                            autosize: true,
                            symbol: `BINANCE:${symbol}`,
                            interval: config.interval,
                            container_id: config.id,
                            theme: theme,
                            style: "1",
                            timezone: "Asia/Kolkata",
                            locale: "en",
                            hide_side_toolbar: true,
                            hide_top_toolbar: true,
                            disabled_features: disabledFeatures,
                            enabled_features: ["hide_left_toolbar_by_default"]
                        });
                    }
                });
            });
            
            window.updateCoinDisplay(symbol);
            
            if (typeof window.AI_ENGINE !== 'undefined' && window.AI_ENGINE.updateForCoin) {
                window.AI_ENGINE.updateForCoin(symbol);
            }
        };
        
        window.updateCoinDisplay = function(symbol) {
            localStorage.setItem('activeSymbol', symbol); 
            const coinName = symbol.replace(/USDT|USD/i, ""); 
            document.getElementById("currentCoin").textContent = coinName;
            
            document.querySelectorAll('.coin-name').forEach(el => {
                el.textContent = coinName;
            });
        };
        
        // ===============================================
        // THEME TOGGLE LOGIC
        // ===============================================

        window.toggleTheme = function() {
            const body = document.body;
            const toggleButton = document.getElementById('themeToggle');
            const icon = toggleButton.querySelector('i');
            
            const isLightMode = body.classList.toggle('light-mode');
            
            if (isLightMode) {
                icon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            } else {
                icon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            }

            window.initCharts(window.ACTIVE_SYMBOL);
        };

        window.loadThemePreference = function() {
            const savedTheme = localStorage.getItem('theme');
            const toggleButton = document.getElementById('themeToggle');
            const icon = toggleButton.querySelector('i');

            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                icon.className = 'fas fa-sun';
            } else {
                document.body.classList.remove('light-mode');
                icon.className = 'fas fa-moon';
            }
            
            toggleButton.onclick = window.toggleTheme;
        };

        // ===============================================
        // COIN SELECTION MODAL
        // ===============================================
        
        window.initCoinModal = function() {
            const coinGrid = document.getElementById("coinGrid");
            if (!coinGrid) return;
            
            coinGrid.innerHTML = '';
            
            window.TRADING_COINS.forEach(coin => {
                const coinName = coin.replace(/USDT|USD/i, "");
                const button = document.createElement('button');
                button.className = `coin-option ${coin === window.ACTIVE_SYMBOL ? 'active' : ''}`;
                
                button.onclick = () => {
                    if (window.ACTIVE_SYMBOL === coin) {
                        window.closeCoinModal();
                        return;
                    }
                    window.ACTIVE_SYMBOL = coin;
                    window.initCharts(coin);
                    window.closeCoinModal();
                    window.updateActiveCoinInModal(coin);
                };

                button.innerHTML = `
                    <i class="${window.getCoinIcon(coinName)}"></i>
                    <span>${coinName}</span>
                `;
                
                coinGrid.appendChild(button);
            });
        };
        
        window.updateActiveCoinInModal = function(selectedCoin) {
            const selectedName = selectedCoin.replace(/USDT|USD/i, "");

            document.querySelectorAll('.coin-option').forEach(option => {
                const optionCoinName = option.querySelector('span').textContent + 'USDT'; 

                option.classList.remove('active');
                if (optionCoinName === selectedCoin) {
                    option.classList.add('active');
                }
            });
        };
        
        window.openCoinModal = function() {
            document.getElementById("coinModal").style.display = 'flex';
            document.body.style.overflow = 'hidden';
            window.updateActiveCoinInModal(window.ACTIVE_SYMBOL);
        };
        
        window.closeCoinModal = function() {
            document.getElementById("coinModal").style.display = 'none';
            document.body.style.overflow = 'auto';
        };
        
        // ===============================================
        // INITIALIZE APP
        // ===============================================
        
        window.initApp = function() {
            console.log("ðŸš€ TradingView HUD Initializing...");
            
            window.loadThemePreference();
            window.initCoinModal();

            // Event listeners
            document.getElementById("coinSelector").onclick = window.openCoinModal;
            document.getElementById("coinModal").onclick = (e) => {
                if (e.target.id === 'coinModal') window.closeCoinModal();
            };
            
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') window.closeCoinModal();
            });
            
            // Check for TradingView widget function availability
            if (typeof TradingView !== 'undefined' && typeof TradingView.widget === 'function') {
                window.initCharts(window.ACTIVE_SYMBOL);
            } else {
                document.getElementById("aiStatus").textContent = "LOADING CHARTS...";
                document.getElementById("aiStatus").className = "color-blue";
                
                let retryCount = 0;
                const maxRetries = 20;
                
                const checkTV = setInterval(() => {
                    if (typeof TradingView !== 'undefined' && typeof TradingView.widget === 'function') {
                        clearInterval(checkTV);
                        window.initCharts(window.ACTIVE_SYMBOL);
                    } else if (retryCount >= maxRetries) {
                        clearInterval(checkTV);
                        document.getElementById("aiStatus").textContent = "CHART ERROR: TV.js FAILED";
                        document.getElementById("aiStatus").className = "color-red";
                        console.error("TradingView widget failed to load after multiple retries.");
                    }
                    retryCount++;
                }, 200);
            }
            
            console.log("âœ… TradingView HUD Ready!");
        };
        
        // Start when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', window.initApp);
        } else {
            window.initApp();
        }
    </script>
</body>
</html>
